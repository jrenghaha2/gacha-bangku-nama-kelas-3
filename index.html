<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Denah Tempat Duduk Kelas - FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-chalkboard: #2c3e50;
            --ui-paper: #fdfbf7;
            --ui-wood: #8e44ad;
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --row1-color: #3498db;
            --row1-bg: linear-gradient(135deg, #ecf6fd 0%, #d6eaf8 100%);
            --row2-color: #2ecc71;
            --row2-bg: linear-gradient(135deg, #eafaf1 0%, #d5f5e3 100%);
            --row3-color: #f39c12;
            --row3-bg: linear-gradient(135deg, #fef9e7 0%, #fdebd0 100%);
            --desk-border: #d35400;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html[data-theme="dark"] {
            --bg-chalkboard: #1a1a1a;
            --ui-paper: #2d2d2d;
            --ui-wood: #bb86fc;
            --text-dark: #e0e0e0;
            --text-light: #ffffff;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-chalkboard);
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            min-height: 100vh; margin: 0; padding: 15px;
            color: var(--text-light);
            overflow-x: hidden;
            transition: background-image 0.3s ease;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: var(--ui-wood); border-radius: 4px; }

        .container { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; }

        .header-section { 
            display: flex; align-items: flex-end; justify-content: flex-start; 
            margin-bottom: 30px; gap: 20px; flex-wrap: wrap; padding-left: 10px; 
            position: relative; z-index: 5;
        }

        .teacher-desk {
            width: 200px; height: 90px;
            background: linear-gradient(to bottom, #a86540, #8d5534);
            color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; border: 3px solid #6d4128; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            flex-shrink: 0; position: relative;
            transition: transform 0.3s ease, width 0.3s ease;
        }

        .teacher-desk.pov-guru-mode { width: 100%; margin: 0; }

        .controls { 
            display: flex; gap: 12px; align-items: center; flex-wrap: wrap; padding-bottom: 5px; 
            position: relative; width: auto;
        }

        .btn-school {
            background: var(--ui-paper); color: var(--text-dark); border: 2px solid var(--ui-wood); 
            border-radius: 12px; padding: 10px 24px; font-size: 14px; font-weight: bold; cursor: pointer; 
            font-family: 'Poppins', sans-serif; position: relative; overflow: hidden; user-select: none;
            box-shadow: 0 3px 0 var(--ui-wood), 0 4px 8px rgba(0,0,0,0.2); transition: all 0.1s; display: flex; align-items: center; gap: 8px;
        }
        .btn-school:hover { opacity: 0.9; }
        .btn-school:active { transform: translateY(3px); box-shadow: 0 0 0 var(--ui-wood); }
        .btn-main-action { background: #3498db; color: white; border-color: #2980b9; box-shadow: 0 3px 0 #2980b9, 0 4px 8px rgba(0,0,0,0.2); }

        .chalk-icon { width: 14px; height: 14px; background: #fff; border-radius: 2px; display: inline-block; border: 1px solid #ccc; }

        .classroom-grid { display: grid; gap: 15px; padding: 15px; align-items: center; background: rgba(255,255,255,0.05); border-radius: 15px; border: 2px dashed rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        
        .footer-section { display: none; gap: 15px; width: 100%; margin-top: 20px; align-items: end; }
        .footer-section.show { display: grid; }

        .seat { aspect-ratio: 4/5; position: relative; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.3s ease; min-height: 120px; border: 3px solid var(--desk-border); background-color: var(--ui-paper); cursor: grab; }
        .seat.dragging { opacity: 0.5; cursor: grabbing; }
        .seat.drag-over { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }

        .seat-row-0 { background: var(--row1-bg); border-bottom: 6px solid var(--row1-color); }
        .seat-row-1 { background: var(--row2-bg); border-bottom: 6px solid var(--row2-color); }
        .seat-row-2 { background: var(--row3-bg); border-bottom: 6px solid var(--row3-color); }

        .seat:hover { transform: translateY(-5px) scale(1.02); z-index: 2; box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        
        .char-img-container { width: 100%; height: 72%; overflow: hidden; position: relative; background-color: rgba(255,255,255,0.5); border-bottom: 2px solid rgba(0,0,0,0.1); }
        .char-img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .seat:hover .char-img { transform: scale(1.05); }

        .char-info { width: 100%; height: 28%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2px 5px; position: relative; color: #000; }

        .seat.is-locked .char-img { filter: grayscale(1) contrast(0.8); opacity: 0.5; }
        .seat.is-locked { border-color: #c0392b !important; }
        
        .lock-box, .hide-desk-btn, .gender-btn { position: absolute; width: 28px; height: 28px; background: var(--ui-paper); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; transition: 0.2s; border: 2px solid; color: var(--text-dark); font-size: 14px; }
        .lock-box { top: 5px; right: 5px; border-color: var(--desk-border); }
        .lock-box:hover { background: var(--desk-border); color: #fff; }
        .hide-desk-btn { top: 5px; left: 5px; border-color: #e74c3c; color: #e74c3c; font-size: 12px; font-weight: bold; }
        .hide-desk-btn:hover { background: #e74c3c; color: #fff; }
        .gender-btn { top: 38px; left: 5px; border-color: #2ecc71; color: #2ecc71; font-size: 14px; }
        .gender-btn:hover { background: #2ecc71; color: #fff; }

        .seat.is-disabled { background: rgba(0,0,0,0.15); border: 2px dashed rgba(255,255,255,0.3); box-shadow: none; cursor: pointer; justify-content: center; align-items: center; }
        .seat.is-disabled:hover { background: rgba(255,255,255,0.1); transform: none; }
        .seat.is-disabled * { display: none; }
        .seat.is-disabled::after { content: attr(data-label); color: rgba(255,255,255,0.6); font-family: 'Poppins', sans-serif; font-size: 12px; font-weight: bold; }

        .seat-name { font-weight: 700; text-align: center; width: 100%; line-height: 1.2; text-transform: uppercase; color: #000 !important; margin-bottom: 0; z-index: 2; font-family: 'Poppins', sans-serif; }
        .text-normal { font-size: 12px; } .text-medium { font-size: 10px; } .text-small { font-size: 9px; } .text-tiny { font-size: 8px; }
        .seat-number { position: absolute; bottom: 2px; right: 4px; font-size: 9px; color: rgba(0,0,0,0.4); font-weight: bold; }

        /* --- POV, THEME, LANG TOGGLES --- */
        .pov-toggle { position: fixed; top: 20px; left: 20px; z-index: 50; background: var(--ui-paper); color: var(--text-dark); border: 2px solid var(--ui-wood); border-radius: 20px; padding: 0 15px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; font-family: 'Poppins', sans-serif; transition: 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2); user-select: none; }
        .pov-toggle:hover { transform: scale(1.05); }
        .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 50; background: var(--ui-paper); border: 2px solid var(--ui-wood); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; transition: 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .theme-toggle:hover { transform: rotate(20deg); }
        .lang-toggle { position: fixed; top: 20px; right: 70px; z-index: 50; background: var(--ui-paper); color: var(--text-dark); border: 2px solid var(--ui-wood); border-radius: 20px; padding: 0 12px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; font-weight: bold; font-family: 'Poppins', sans-serif; transition: 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.2); user-select: none; }
        .lang-toggle:hover { transform: scale(1.05); }

        /* --- MODAL & SETTINGS --- */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px); overflow-y: auto; }
        .modal.show { display: block; }
        .modal-content { background: var(--ui-paper); color: var(--text-dark); margin: 5% auto; padding: 25px; width: 90%; max-width: 550px; border-radius: 12px; height: 80vh; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 0 0 4px rgba(255,255,255,0.5), 0 15px 40px rgba(0,0,0,0.5); position: relative; border: 3px solid var(--ui-wood); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px dashed rgba(0,0,0,0.1); padding-bottom: 10px; }
        .modal-title { margin: 0; font-family: 'Poppins', sans-serif; color: var(--ui-wood); font-size: 22px; font-weight: 700; }
        .close-btn { width: 30px; height: 30px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; color: #555; transition: 0.2s; border: none;}
        .close-btn:hover { background: #c0392b; color: #fff; }
        .manager-input { width: 100%; padding: 12px; border: 2px solid #ddd; background: #fff; border-radius: 10px; font-family: inherit; font-weight: bold; color: var(--text-dark); margin-bottom: 10px;}
        .manager-input:focus { outline: none; border-color: var(--ui-wood); }
        .name-list { flex: 1 1 auto; min-height: 0; overflow-y: auto; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(0,0,0,0.1);}
        .name-item { padding: 10px 15px; margin-bottom: 8px; border-radius: 8px; background: #fff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; color: var(--text-dark); font-weight: 700; border: 1px solid #eee;}
        .name-item:hover { transform: translateX(3px); border-left: 4px solid var(--ui-wood); }
        .name-item.eliminated span { opacity: 0.5; text-decoration: line-through; color: #c0392b; }
        .action-btn { width: 28px; height: 28px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 5px; font-size: 12px; transition: 0.2s;}
        .action-btn:active { transform: translateY(2px); }
        .btn-status-on { background: #abebc6; color: #27ae60; width: auto; padding: 0 10px; }
        .btn-status-off { background: #fadbd8; color: #c0392b; width: auto; padding: 0 10px; }
        .btn-edit { background: #d4e4ff; color: #2980b9; } 
        .btn-del { background: #fadbd8; color: #c0392b; }
        textarea.manager-input { flex: 1 1 auto; min-height: 0; overflow-y: auto; padding: 15px; border-radius: 8px; border: 2px solid #ddd; font-family: monospace; color: var(--text-dark); background: #fff; resize: none; margin-bottom: 15px;}
        .modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 10px;}

        /* --- PICKER SPECIFIC STYLES --- */
        .picker-display {
            font-size: 2.2rem; font-weight: 800; min-height: 5.5rem; display: flex;
            justify-content: center; align-items: center; background: rgba(0,0,0,0.05);
            border-radius: 14px; margin: 10px 0 15px 0; color: var(--ui-wood);
            border: 3px dashed var(--ui-wood); padding: 15px; text-align: center;
            font-family: 'Poppins', sans-serif; text-transform: uppercase;
        }
        html[data-theme="dark"] .picker-display {
            background: rgba(255,255,255,0.05); color: #00ffcc; border-color: #555;
        }
        .picker-history-list {
            flex: 1 1 auto; min-height: 0; overflow-y: auto; background: rgba(0,0,0,0.03); 
            padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid rgba(0,0,0,0.1);
        }
        .history-item-picker {
            background: #fff; padding: 10px 15px; margin-bottom: 8px; border-radius: 8px;
            border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-family: 'Poppins', sans-serif;
        }
        html[data-theme="dark"] .history-item-picker {
            background: #252525; border-color: #2f2f2f; color: #fff;
        }

        /* --- TOAST & STATS --- */
        .toast { position: fixed; bottom: 20px; right: 20px; z-index: 2000; background: #2c3e50; color: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; max-width: 300px;}
        .toast.success { background: #27ae60; }
        .toast.error { background: #c0392b; }
        .toast.info { background: #3498db; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .stats-panel { display: none; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px; position: relative;}
        .stat-card { background: var(--ui-paper); padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid var(--ui-wood);}
        .stat-value { font-size: 24px; font-weight: 700; color: var(--ui-wood); }
        .stat-label { font-size: 12px; color: #7f8c8d; margin-top: 5px; }

        @media (max-width: 768px) {
            .pov-toggle { top: 10px; left: 10px; font-size: 12px; height: 35px; padding: 0 10px; }
            .theme-toggle { top: 10px; right: 10px; width: 35px; height: 35px; }
            .lang-toggle { top: 10px; right: 55px; height: 35px; font-size: 12px; }
            .header-section { flex-direction: column; align-items: center; padding-left: 0; gap: 10px; margin-top: 35px; }
            .controls { justify-content: center; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .classroom-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; padding: 8px; }
            
            .footer-section.show { display: flex !important; flex-direction: column-reverse; padding: 0; gap: 20px; }
            .teacher-desk.pov-guru-mode { grid-column: auto !important; width: 100%; margin: 0; }
            .controls.pov-guru-mode { justify-content: center !important; grid-column: auto !important; }

            .seat { min-height: 85px; flex-direction: row; justify-content: space-between; }
            .char-img-container { width: 70px; height: 100%; border-right: 2px solid var(--desk-border); }
            .char-info { width: calc(100% - 70px); }
            .modal-content { height: 90vh; width: 95%; }
            .picker-display { font-size: 1.8rem; min-height: 4.5rem; }
        }

        @media print {
            .controls, .modal, .lock-box, .gender-btn, .hide-desk-btn, .theme-toggle, .pov-toggle, .lang-toggle, .stats-panel { display: none !important; }
            body { background: white !important; background-image: none !important; }
            .teacher-desk.pov-guru-mode { margin-top: 20px; }
        }
    </style>
</head>
<body>

<div class="pov-toggle" id="btnPovToggle" onclick="togglePOV()">üë®‚Äçüè´ POV Guru</div>
<div class="lang-toggle" id="btnLangToggle" onclick="toggleLang()" title="Ubah Bahasa / Change Language">üáÆüá© ID</div>
<div class="theme-toggle" onclick="toggleDarkMode()" title="Dark/Light Mode">üåô</div>

<div class="container">
    <div class="header-section" id="topHeader">
        <div class="teacher-desk" id="teacherDeskObj">
            <div id="teacherDeskTopTxt" style="font-size: 10px; opacity: 0.9; letter-spacing: 1px; margin-bottom: 2px; font-family: 'Quicksand', sans-serif; color: #f0f0f0;">üè´ ABSENSI KELAS</div>
            <div id="teacherDeskMainTxt" style="font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 20px; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">MEJA GURU</div>
        </div>
        <div class="controls" id="controlsObj">
            <button class="btn-school btn-main-action" onclick="handleShuffle()">
                <div class="chalk-icon"></div> <span id="txtBtnShuffle">ACAK POSISI</span>
            </button>
            <button class="btn-school" onclick="handleOpenPicker()">
                <span id="txtBtnPicker">üé≤ ACAK NAMA</span>
            </button>
            <button class="btn-school" onclick="handleOpenManager()">
                <span id="txtBtnData">üìã DATA SISWA</span>
            </button>
            <button class="btn-school" onclick="handleOpenSettings()">
                <span id="txtBtnSettings">‚öôÔ∏è PENGATURAN KELAS</span>
            </button>
            <button class="btn-school" onclick="handleShowStats()">
                <span id="txtBtnStats">üìä STATISTIK</span>
            </button>
            <button class="btn-school" onclick="handlePrint()">
                <span id="txtBtnPrint">üñ®Ô∏è CETAK</span>
            </button>
        </div>
    </div>

    <div id="statsPanel" class="stats-panel"></div>

    <div id="classroom" class="classroom-grid"></div>
    
    <div class="footer-section" id="bottomFooter"></div>
</div>

<div id="mainModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">BUKU ABSEN SISWA</h2>
            <button class="close-btn" onclick="handleCloseModal()">‚úï</button>
        </div>
        
        <div id="normalView" style="display:flex; flex-direction:column; flex:1; min-height:0;">
            <div style="font-size:13px; margin-bottom:10px; color:#7f8c8d; font-weight: bold;">
                <span id="txtLblTotal">Total Siswa:</span> <span id="studentCount">0</span> <span id="txtLblSiswa">Siswa</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:10px; flex-shrink:0;">
                <input type="text" id="newNameInput" class="manager-input" placeholder="Nama siswa baru...">
                <button class="btn-school btn-main-action" onclick="handleAddName()" style="padding:0 20px;" id="txtBtnAdd">TAMBAH</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:10px; flex-shrink:0;">
                <input type="text" id="searchInput" class="manager-input" placeholder="üîç Cari..." onkeyup="renderNameList()">
                <button class="btn-school" onclick="handleOpenBulk()" style="padding:0 15px;" id="txtBtnBulk">üìù BANYAK</button>
                <button class="btn-school" onclick="handleOpenSort()" style="padding:0 15px;" id="txtBtnSort">‚ÜïÔ∏è URUT</button>
            </div>
            <div class="name-list" id="nameListContainer"></div>
            <div class="modal-footer">
                <button class="btn-school" style="color:#c0392b; background:#fce4ec; border-color:#edaebb; justify-content:center;" onclick="handleEliminateAll()" id="txtBtnAbsAll">ABSEN SEMUA</button>
                <button class="btn-school" style="color:#27ae60; background:#e8f8f5; border-color:#aedeba; justify-content:center;" onclick="handleRestoreAll()" id="txtBtnPresAll">HADIR SEMUA</button>
                <button class="btn-school" style="grid-column:span 2; background:#eee; color:#555; justify-content:center;" onclick="handleResetDefault()" id="txtBtnReset">RESET</button>
            </div>
        </div>

        <div id="bulkView" style="display:none; flex-direction:column; flex:1; min-height:0;">
            <p style="margin:10px 0 5px 0; font-size:13px; color:#7f8c8d; font-weight:bold;" id="txtLblBulkDesc">Input nama (1 per baris):</p>
            <textarea id="bulkEditArea" class="manager-input" placeholder="BUDI&#10;SITI&#10;AYU"></textarea>
            <div style="display:flex; gap:10px; flex-shrink:0;">
                <button class="btn-school" style="flex:1; color:#c0392b; background:#fce4ec;" onclick="handleBack()" id="txtBtnCancel1">Batal</button>
                <button class="btn-school btn-main-action" style="flex:1;" onclick="handleSaveBulk()" id="txtBtnSave1">SIMPAN</button>
            </div>
        </div>

        <div id="sortView" style="display:none; flex-direction:column; flex:1; min-height:0;">
            <p style="margin:15px 0; font-weight:bold;" id="txtLblSort">Pilih urutan:</p>
            <button class="btn-school" style="margin-bottom:10px; justify-content:center;" onclick="handleSort('alpha'); handleCloseModal();" id="txtBtnSortAZ">A-Z</button>
            <button class="btn-school" style="margin-bottom:10px; justify-content:center;" onclick="handleSort('status'); handleCloseModal();" id="txtBtnSortStat">Status</button>
            <button class="btn-school" style="background:#fce4ec; color:#c0392b; justify-content:center;" onclick="handleBack()" id="txtBtnCancel2">Batal</button>
        </div>

        <div id="settingsView" style="display:none; flex-direction:column; flex:1; min-height:0; overflow-y:auto; padding:10px 0;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;" id="txtLblRows">Jumlah Baris:</label>
            <input type="number" id="inputRows" class="manager-input" min="1" max="10" value="3" style="margin-bottom:15px;">
            
            <label style="font-weight:bold; display:block; margin-bottom:5px;" id="txtLblCols">Jumlah Kolom:</label>
            <input type="number" id="inputCols" class="manager-input" min="1" max="15" value="6" style="margin-bottom:15px;">
            
            <button class="btn-school btn-main-action" style="width:100%; justify-content:center; margin-bottom:20px;" onclick="handleApplyGrid()" id="txtBtnSaveGrid">SIMPAN GRID</button>
            
            <hr style="margin:15px 0; border:1px solid #ddd;">
            
            <label style="font-weight:bold; display:block; margin-bottom:10px;" id="txtLblBg">üñºÔ∏è BACKGROUND KELAS:</label>
            <button class="btn-school" style="width:100%; justify-content:center; margin-bottom:8px; background:#f39c12; color:#fff; border-color:#e67e22;" onclick="document.getElementById('bgInput').click()" id="txtBtnUpBg">üì∑ UPLOAD BACKGROUND</button>
            <button class="btn-school" style="width:100%; justify-content:center; background:#ecf0f1; color:#7f8c8d; border-color:#bdc3c7;" onclick="handleResetBackground()" id="txtBtnDelBg">üóëÔ∏è HAPUS BACKGROUND</button>
            <input type="file" id="bgInput" accept="image/*" style="display:none;" onchange="handleBackgroundUpload(event)">

            <hr style="margin:15px 0; border:1px solid #ddd;">

            <label style="font-weight:bold; display:block; margin-bottom:10px;" id="txtLblBackup">üíæ BACKUP DATA:</label>
            <button class="btn-school" style="width:100%; justify-content:center; margin-bottom:8px; background:#d4e4ff; border-color:#3498db; color:#2980b9;" onclick="handleSaveJSON()" id="txtBtnSaveJ">üíæ SAVE JSON</button>
            <button class="btn-school" style="width:100%; justify-content:center; background:#e8f8f5; border-color:#27ae60; color:#27ae60;" onclick="handleLoadJSON()" id="txtBtnLoadJ">üìÇ LOAD JSON</button>
            <input type="file" id="fileInput" accept=".json" style="display:none;" onchange="loadJSONFile(event)">
        </div>

        <div id="pickerView" style="display:none; flex-direction:column; flex:1; min-height:0;">
            <div style="text-align:center; color: #7f8c8d; font-size: 14px; font-weight: bold; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px; margin-bottom: 10px;">
                <span id="labelAvailable">Belum Terpilih: </span> <span id="pickerAvailableCount" style="color:var(--ui-wood);">0</span> / <span id="pickerTotalCount">0</span> <span id="txtLblHadir">Siswa Hadir</span>
            </div>
            
            <div style="display: flex; justify-content: center; margin-bottom: 5px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; font-weight: bold; color: var(--text-dark);">
                    <input type="checkbox" id="allowRepeatCheck" onchange="toggleRepeatPick()" style="width: 16px; height: 16px; cursor: pointer;">
                    <span id="txtLblRepeat">Bisa Terpilih Berkali-kali</span>
                </label>
            </div>
            
            <div id="pickerDisplay" class="picker-display">SIAP ACAK</div>
            
            <button class="btn-school btn-main-action" id="btnDoPick" style="width:100%; justify-content:center; padding: 18px; font-size: 18px; letter-spacing: 1px;" onclick="doPickName()">üé≤ MULAI ACAK</button>
            
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-shrink: 0;">
                <button class="btn-school" style="flex: 1; justify-content:center; background:#d4e4ff; border-color:#3498db; color:#2980b9;" onclick="undoPick()" id="txtBtnUndo">‚Ü©Ô∏è Undo</button>
                <button class="btn-school" style="flex: 1; justify-content:center; color:#c0392b; background:#fce4ec; border-color:#edaebb;" onclick="resetPickerHistory()" id="txtBtnResetPick">üóëÔ∏è Reset</button>
            </div>

            <div style="margin-top: 15px; font-size: 12px; font-weight: bold; color: #7f8c8d;" id="txtLblHist">RIWAYAT TERPILIH:</div>
            <div class="picker-history-list" id="pickerHistoryContainer"></div>
        </div>

    </div>
</div>

<script>
    // === DICTIONARY BAHASA (i18n) ===
    const i18n = {
        id: {
            povT: "üë®‚Äçüè´ POV Guru", povS: "üßë‚Äçüéì POV Murid",
            toastPovT: "Mode POV Guru Aktif üë®‚Äçüè´", toastPovS: "Mode POV Murid Aktif üßë‚Äçüéì",
            tDeskTop: "üè´ ABSENSI KELAS", tDeskMain: "MEJA GURU",
            btnShuf: "ACAK POSISI", btnPick: "üé≤ ACAK NAMA", btnData: "üìã DATA SISWA", btnSet: "‚öôÔ∏è PENGATURAN KELAS", btnStat: "üìä STATISTIK", btnPrint: "üñ®Ô∏è CETAK",
            stTot: "Total", stPres: "Hadir", stAbs: "Absen", stSeat: "Kursi", stOcc: "Okupansi",
            modData: "BUKU ABSEN SISWA", modBulk: "üìù INPUT BANYAK", modSort: "‚ÜïÔ∏è URUTKAN DATA", modSet: "‚öôÔ∏è PENGATURAN KELAS", modPick: "üé≤ RANDOM NAME PICKER",
            lblTot: "Total Siswa: ", lblSis: " Siswa", phNew: "Nama siswa baru...", btnAdd: "TAMBAH", phSearch: "üîç Cari...",
            btnBulk: "üìù BANYAK", btnSort: "‚ÜïÔ∏è URUT", btnAbsAll: "ABSEN SEMUA", btnPresAll: "HADIR SEMUA", btnReset: "RESET",
            lblBulk: "Input nama (1 per baris):", phBulk: "BUDI\nSITI\nAYU", btnCancel: "Batal", btnSave: "SIMPAN",
            lblSort: "Pilih urutan:", btnSortStatus: "Status",
            lblRow: "Jumlah Baris:", lblCol: "Jumlah Kolom:", btnSaveGrid: "SIMPAN GRID",
            lblBg: "üñºÔ∏è BACKGROUND KELAS:", btnUpBg: "üì∑ UPLOAD BACKGROUND", btnDelBg: "üóëÔ∏è HAPUS BACKGROUND",
            lblBack: "üíæ BACKUP DATA:", btnSaveJ: "üíæ SAVE JSON", btnLoadJ: "üìÇ LOAD JSON",
            lblUnpick: "Belum Terpilih: ", lblCand: "Kandidat Acak: ", lblHadir: " Siswa Hadir", lblRep: "Bisa Terpilih Berkali-kali",
            pickReady: "SIAP ACAK", btnDoPick: "üé≤ MULAI ACAK", btnUndo: "‚Ü©Ô∏è Undo", btnResPick: "üóëÔ∏è Reset", lblHist: "RIWAYAT TERPILIH:", pickDone: "SELESAI",
            lblAbsent: "(Sedang Absen)", emptySeat: "KOSONG", seatNum: "MEJA ", openSeat: "+ Buka Meja",
            statHadir: "HADIR", statAbsen: "ABSEN",
            pmtName: "Nama:", confDel: "Hapus?", confAbsAll: "Tandai semua ABSEN?", confReset: "Reset ke data awal?", confLoad: "‚ö†Ô∏è Load data ini?\n\nData lama akan diganti!", confResPick: "Reset seluruh riwayat undian kelas?",
            tsShuf: "Posisi diacak ‚úì", tsAdd: " ditambahkan ‚úì", tsMax: "Max ", tsMaxS: " siswa!", tsSave: "Data disimpan ‚úì", tsSort: "Data diurutkan ‚úì", tsGrid: "Grid disimpan ‚úì", tsAbsAll: "Semua ABSEN", tsPresAll: "Semua HADIR", tsRes: "Data direset ‚úì", tsProcBg: "‚è≥ Memproses gambar...", tsErrBg: "‚ùå Gagal: Gambar ini masih terlalu berat memori.", tsSuccBg: "‚úÖ Gambar dikompres & dipasang!", tsDelBg: "üóëÔ∏è Background direset ke default", tsSaveJ: "‚úÖ JSON berhasil disave!", tsLoadJ: "‚úÖ JSON berhasil diload!", tsErrJ: "‚ùå File tidak valid!", tsErrNo: "Tidak ada siswa yang HADIR di kelas.", tsErrAll: "Semua siswa yang hadir sudah terpilih!", tsPick: "Terpilih: ", tsErrNoU: "Belum ada nama yang terpilih.", tsUndo: "Dibatalkan: ", tsResPick: "Riwayat berhasil di-reset."
        },
        en: {
            povT: "üë®‚Äçüè´ Teacher POV", povS: "üßë‚Äçüéì Student POV",
            toastPovT: "Teacher POV Active üë®‚Äçüè´", toastPovS: "Student POV Active üßë‚Äçüéì",
            tDeskTop: "üè´ CLASS ATTENDANCE", tDeskMain: "TEACHER DESK",
            btnShuf: "SHUFFLE SEATS", btnPick: "üé≤ RANDOM PICKER", btnData: "üìã STUDENTS DATA", btnSet: "‚öôÔ∏è SETTINGS", btnStat: "üìä STATISTICS", btnPrint: "üñ®Ô∏è PRINT",
            stTot: "Total", stPres: "Present", stAbs: "Absent", stSeat: "Seats", stOcc: "Occupancy",
            modData: "STUDENTS DATA", modBulk: "üìù BULK INPUT", modSort: "‚ÜïÔ∏è SORT DATA", modSet: "‚öôÔ∏è SETTINGS", modPick: "üé≤ RANDOM NAME PICKER",
            lblTot: "Total Students: ", lblSis: " Students", phNew: "New student name...", btnAdd: "ADD", phSearch: "üîç Search...",
            btnBulk: "üìù BULK", btnSort: "‚ÜïÔ∏è SORT", btnAbsAll: "ALL ABSENT", btnPresAll: "ALL PRESENT", btnReset: "RESET",
            lblBulk: "Input names (1 per line):", phBulk: "JOHN\nJANE\nDOE", btnCancel: "Cancel", btnSave: "SAVE",
            lblSort: "Sort by:", btnSortStatus: "Status",
            lblRow: "Rows Count:", lblCol: "Cols Count:", btnSaveGrid: "SAVE GRID",
            lblBg: "üñºÔ∏è CLASS BACKGROUND:", btnUpBg: "üì∑ UPLOAD BACKGROUND", btnDelBg: "üóëÔ∏è REMOVE BACKGROUND",
            lblBack: "üíæ BACKUP DATA:", btnSaveJ: "üíæ SAVE JSON", btnLoadJ: "üìÇ LOAD JSON",
            lblUnpick: "Not Picked: ", lblCand: "Candidates: ", lblHadir: " Present Students", lblRep: "Allow Repeat Pick",
            pickReady: "READY TO PICK", btnDoPick: "üé≤ START PICKING", btnUndo: "‚Ü©Ô∏è Undo", btnResPick: "üóëÔ∏è Reset", lblHist: "PICK HISTORY:", pickDone: "DONE",
            lblAbsent: "(Currently Absent)", emptySeat: "EMPTY", seatNum: "SEAT ", openSeat: "+ Open Seat",
            statHadir: "PRESENT", statAbsen: "ABSENT",
            pmtName: "Name:", confDel: "Delete?", confAbsAll: "Mark all as ABSENT?", confReset: "Reset to default data?", confLoad: "‚ö†Ô∏è Load this data?\n\nOld data will be replaced!", confResPick: "Reset the entire picking history?",
            tsShuf: "Seats shuffled ‚úì", tsAdd: " added ‚úì", tsMax: "Max ", tsMaxS: " students!", tsSave: "Data saved ‚úì", tsSort: "Data sorted ‚úì", tsGrid: "Grid saved ‚úì", tsAbsAll: "All ABSENT", tsPresAll: "All PRESENT", tsRes: "Data reset ‚úì", tsProcBg: "‚è≥ Processing image...", tsErrBg: "‚ùå Failed: Image is too large.", tsSuccBg: "‚úÖ Image compressed & applied!", tsDelBg: "üóëÔ∏è Background reset to default", tsSaveJ: "‚úÖ JSON saved successfully!", tsLoadJ: "‚úÖ JSON loaded successfully!", tsErrJ: "‚ùå Invalid file!", tsErrNo: "No PRESENT students in class.", tsErrAll: "All present students have been picked!", tsPick: "Picked: ", tsErrNoU: "No name picked yet.", tsUndo: "Undid: ", tsResPick: "History reset successfully."
        }
    };

    let currentLang = 'id';

    // === SISTEM CRYPTO SECURE RANDOM ===
    function getSecureRandomInt(max) {
        const randomBuffer = new Uint32Array(1);
        window.crypto.getRandomValues(randomBuffer);
        return randomBuffer[0] % max;
    }

    // === DATA KELAS ===
    const knownGenders = {
        "RAHMA": "F", "TASYA": "F", "AKHSIN AMIRULLOH": "M",
        "ZERLINA": "F", "YEHEZKIEL RAMLAN": "M", "MAYANG": "F",
        "NATASHA": "F", "GALIH": "M", "MURSID": "M",
        "IFA": "F", "KRIS": "M", "HARIS": "M",
        "DESPIA": "F", "FAIQ": "M", "ANGGUN": "F",
        "REGA": "F", "DENDRA": "M", "IYAN.": "M"
    };

    const defaultNames = Object.keys(knownGenders);
    let masterNames = defaultNames.map(name => ({ name: name, active: true }));
    let seats = [];
    let totalRows = 3;
    let totalCols = 6;
    let historyData = [];
    let historyIndex = -1;
    let modalHistory = []; 
    let isTeacherPOV = false; 
    let customBackground = null;
    let pickerHistory = []; 
    let allowRepeatPick = false; 
    let customGenders = {};

    function toggleLang() {
        currentLang = currentLang === 'id' ? 'en' : 'id';
        localStorage.setItem('appLang', currentLang);
        applyLangUI();
        renderSeats();
        renderNameList();
        renderPickerUI();
        if (document.getElementById('statsPanel').style.display === 'grid') handleShowStats();
    }

    function applyLangUI() {
        const t = i18n[currentLang];
        document.getElementById('btnLangToggle').textContent = currentLang === 'id' ? 'üáÆüá© ID' : 'üá∫üá∏ EN';
        document.getElementById('btnPovToggle').textContent = isTeacherPOV ? t.povS : t.povT;
        
        document.getElementById('teacherDeskTopTxt').textContent = t.tDeskTop;
        document.getElementById('teacherDeskMainTxt').textContent = t.tDeskMain;
        
        document.getElementById('txtBtnShuffle').textContent = t.btnShuf;
        document.getElementById('txtBtnPicker').textContent = t.btnPick;
        document.getElementById('txtBtnData').textContent = t.btnData;
        document.getElementById('txtBtnSettings').textContent = t.btnSet;
        document.getElementById('txtBtnStats').textContent = t.btnStat;
        document.getElementById('txtBtnPrint').textContent = t.btnShuf; // Typo fix visual
        document.getElementById('txtBtnPrint').textContent = t.btnPrint;
        
        document.getElementById('txtLblTotal').textContent = t.lblTot;
        document.getElementById('txtLblSiswa').textContent = t.lblSis;
        document.getElementById('newNameInput').placeholder = t.phNew;
        document.getElementById('txtBtnAdd').textContent = t.btnAdd;
        document.getElementById('searchInput').placeholder = t.phSearch;
        document.getElementById('txtBtnBulk').textContent = t.btnBulk;
        document.getElementById('txtBtnSort').textContent = t.btnSort;
        document.getElementById('txtBtnAbsAll').textContent = t.btnAbsAll;
        document.getElementById('txtBtnPresAll').textContent = t.btnPresAll;
        document.getElementById('txtBtnReset').textContent = t.btnReset;
        
        document.getElementById('txtLblBulkDesc').textContent = t.lblBulk;
        document.getElementById('bulkEditArea').placeholder = t.phBulk;
        document.getElementById('txtBtnCancel1').textContent = t.btnCancel;
        document.getElementById('txtBtnSave1').textContent = t.btnSave;
        
        document.getElementById('txtLblSort').textContent = t.lblSort;
        document.getElementById('txtBtnSortStat').textContent = t.btnSortStatus;
        document.getElementById('txtBtnCancel2').textContent = t.btnCancel;
        
        document.getElementById('txtLblRows').textContent = t.lblRow;
        document.getElementById('txtLblCols').textContent = t.lblCol;
        document.getElementById('txtBtnSaveGrid').textContent = t.btnSaveGrid;
        document.getElementById('txtLblBg').textContent = t.lblBg;
        document.getElementById('txtBtnUpBg').textContent = t.btnUpBg;
        document.getElementById('txtBtnDelBg').textContent = t.btnDelBg;
        document.getElementById('txtLblBackup').textContent = t.lblBack;
        document.getElementById('txtBtnSaveJ').textContent = t.btnSaveJ;
        document.getElementById('txtBtnLoadJ').textContent = t.btnLoadJ;
        
        document.getElementById('txtLblHadir').textContent = t.lblHadir;
        document.getElementById('txtLblRepeat').textContent = t.lblRep;
        document.getElementById('btnDoPick').textContent = t.btnDoPick;
        document.getElementById('txtBtnUndo').textContent = t.btnUndo;
        document.getElementById('txtBtnResetPick').textContent = t.btnResPick;
        document.getElementById('txtLblHist').textContent = t.lblHist;

        const mTitle = document.getElementById('modalTitle');
        if (document.getElementById('normalView').style.display !== 'none') mTitle.textContent = t.modData;
        else if (document.getElementById('bulkView').style.display !== 'none') mTitle.textContent = t.modBulk;
        else if (document.getElementById('sortView').style.display !== 'none') mTitle.textContent = t.modSort;
        else if (document.getElementById('settingsView').style.display !== 'none') mTitle.textContent = t.modSet;
        else if (document.getElementById('pickerView').style.display !== 'none') mTitle.textContent = t.modPick;
    }

    function showView(viewId, title) {
        document.getElementById('normalView').style.display = 'none';
        document.getElementById('bulkView').style.display = 'none';
        document.getElementById('sortView').style.display = 'none';
        document.getElementById('settingsView').style.display = 'none';
        document.getElementById('pickerView').style.display = 'none'; 

        if(viewId) {
            document.getElementById('mainModal').classList.add('show');
            document.getElementById(viewId).style.display = 'flex';
            document.getElementById('modalTitle').textContent = title;
        } else {
            document.getElementById('mainModal').classList.remove('show');
        }
    }

    function pushView(viewId, title) {
        modalHistory.push({ id: viewId, title: title });
        history.pushState({ modal: viewId }, '');
        showView(viewId, title);
    }

    function handleBack() { history.back(); }

    window.addEventListener('popstate', (e) => {
        modalHistory.pop();
        if (modalHistory.length > 0) {
            const prev = modalHistory[modalHistory.length - 1];
            showView(prev.id, prev.title);
        } else {
            showView(null);
        }
    });

    function handleOpenManager() {
        modalHistory = []; pushView('normalView', i18n[currentLang].modData); renderNameList();
    }
    function handleOpenSettings() {
        modalHistory = []; pushView('settingsView', i18n[currentLang].modSet);
        document.getElementById('inputRows').value = totalRows;
        document.getElementById('inputCols').value = totalCols;
    }
    function handleOpenBulk() {
        pushView('bulkView', i18n[currentLang].modBulk);
        document.getElementById('bulkEditArea').value = masterNames.map(n => n.name).join('\n');
    }
    function handleOpenSort() { pushView('sortView', i18n[currentLang].modSort); }
    
    function handleCloseModal() {
        if(modalHistory.length > 0) { history.go(-modalHistory.length); modalHistory = []; } 
        else { showView(null); }
    }

    function handleOpenPicker() {
        modalHistory = []; pushView('pickerView', i18n[currentLang].modPick); renderPickerUI();
    }
    
    function toggleRepeatPick() {
        allowRepeatPick = document.getElementById('allowRepeatCheck').checked;
        saveState(); renderPickerUI();
    }

    function renderPickerUI() {
        const t = i18n[currentLang];
        const presentNames = masterNames.filter(n => n.active).map(n => n.name);
        
        let available = [];
        if (allowRepeatPick) { available = [...presentNames]; } 
        else { available = presentNames.filter(name => !pickerHistory.some(h => h.name === name)); }
        
        document.getElementById('pickerTotalCount').textContent = presentNames.length;
        document.getElementById('pickerAvailableCount').textContent = available.length;
        document.getElementById('labelAvailable').textContent = allowRepeatPick ? t.lblCand : t.lblUnpick;
        
        const listEl = document.getElementById('pickerHistoryContainer');
        listEl.innerHTML = '';
        
        const reversed = pickerHistory.slice().reverse();
        reversed.forEach((h, idx) => {
            const isCurrentlyAbsent = !presentNames.includes(h.name);
            const statusLabel = isCurrentlyAbsent ? ` <span style="font-size:10px; color:#e74c3c;">${t.lblAbsent}</span>` : '';
            const decoration = isCurrentlyAbsent ? 'text-decoration: line-through; opacity: 0.6;' : '';

            const div = document.createElement('div');
            div.className = 'history-item-picker';
            
            const date = new Date(h.time);
            const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
            
            div.innerHTML = `
                <div>
                    <strong style="color:var(--ui-wood); margin-right: 8px;">#${pickerHistory.length - idx}</strong> 
                    <span style="font-weight: 700; ${decoration}">${h.name}</span>${statusLabel}
                </div>
                <div style="font-size: 0.75rem; color: #7f8c8d; font-weight: bold;">${timeStr}</div>
            `;
            listEl.appendChild(div);
        });

        const display = document.getElementById('pickerDisplay');
        if (available.length === 0 && presentNames.length > 0 && pickerHistory.length > 0) {
            display.innerText = t.pickDone; display.style.color = "#2ecc71";
        } else if (display.innerText !== t.pickReady && (!allowRepeatPick && !pickerHistory.some(h => h.name === display.innerText))) {
            display.innerText = t.pickReady; display.style.color = "";
        }
    }

    function doPickName() {
        const t = i18n[currentLang];
        const presentNames = masterNames.filter(n => n.active).map(n => n.name);
        let available = [];
        if (allowRepeatPick) { available = [...presentNames]; } 
        else { available = presentNames.filter(name => !pickerHistory.some(h => h.name === name)); }
        
        if (presentNames.length === 0) { showToast(t.tsErrNo, 'error'); return; }
        if (available.length === 0) { showToast(t.tsErrAll, 'error'); return; }

        const btn = document.getElementById('btnDoPick');
        const display = document.getElementById('pickerDisplay');
        btn.disabled = true; btn.style.opacity = '0.5';
        
        try { if (navigator.vibrate) navigator.vibrate(10); } catch (e) {}

        let i = 0;
        const loop = setInterval(() => {
            const randIndex = getSecureRandomInt(available.length);
            display.innerText = available[randIndex];
            display.style.color = "";

            if (i++ > 15) {
                clearInterval(loop);
                const winnerIndex = getSecureRandomInt(available.length);
                const winner = available[winnerIndex];
                
                pickerHistory.push({ name: winner, time: Date.now() });
                display.innerText = winner; display.style.color = '#e74c3c'; 
                try { if (navigator.vibrate) navigator.vibrate(30); } catch (e) {}
                showToast(t.tsPick + winner, 'success');

                renderPickerUI(); saveState(); 
                btn.disabled = false; btn.style.opacity = '1';
            }
        }, 60);
    }

    function undoPick() {
        const t = i18n[currentLang];
        if (pickerHistory.length === 0) { showToast(t.tsErrNoU, 'info'); return; }
        const last = pickerHistory.pop();
        const display = document.getElementById('pickerDisplay');
        display.innerText = t.pickReady; display.style.color = "";
        
        renderPickerUI(); saveState(); showToast(t.tsUndo + last.name, 'info');
    }

    function resetPickerHistory() {
        const t = i18n[currentLang];
        if (pickerHistory.length === 0) return;
        if (confirm(t.confResPick)) {
            pickerHistory = [];
            const display = document.getElementById('pickerDisplay');
            display.innerText = t.pickReady; display.style.color = "";
            renderPickerUI(); saveState(); showToast(t.tsResPick, 'success');
        }
    }

    function handleShuffle() { distributeNames(); saveToHistory(); renderSeats(); saveState(); showToast(i18n[currentLang].tsShuf, 'success'); }

    function handleShowStats() {
        const t = i18n[currentLang];
        const panel = document.getElementById('statsPanel');
        if (panel.style.display === 'grid') { panel.style.display = 'none'; return; }
        
        const present = masterNames.filter(n => n.active).length;
        const absent = masterNames.length - present;
        const activeSeats = getActiveSeatCount();
        const occupancy = activeSeats > 0 ? ((present / activeSeats) * 100).toFixed(1) : 0;

        panel.innerHTML = `
            <div class="stat-card"><div class="stat-value">${masterNames.length}</div><div class="stat-label">${t.stTot}</div></div>
            <div class="stat-card"><div class="stat-value">${present}</div><div class="stat-label">${t.stPres}</div></div>
            <div class="stat-card"><div class="stat-value">${absent}</div><div class="stat-label">${t.stAbs}</div></div>
            <div class="stat-card"><div class="stat-value">${activeSeats}</div><div class="stat-label">${t.stSeat}</div></div>
            <div class="stat-card"><div class="stat-value">${occupancy}%</div><div class="stat-label">${t.stOcc}</div></div>
        `;
        panel.style.display = 'grid';
    }

    function handlePrint() { window.print(); }

    function handleAddName() {
        const t = i18n[currentLang];
        const val = document.getElementById('newNameInput').value.trim().toUpperCase();
        const maxS = getActiveSeatCount();
        if (val && masterNames.length < maxS) {
            masterNames.push({ name: val, active: true });
            document.getElementById('newNameInput').value = '';
            renderNameList(); distributeNames(); saveToHistory(); renderSeats(); saveState();
            showToast(`${val}${t.tsAdd}`, 'success');
        }
    }

    function handleSaveBulk() {
        const t = i18n[currentLang];
        const lines = document.getElementById('bulkEditArea').value.split('\n').map(s => s.trim().toUpperCase()).filter(s => s);
        const maxS = getActiveSeatCount();
        if (lines.length > maxS) { showToast(`${t.tsMax}${maxS}${t.tsMaxS}`, 'error'); return; }
        masterNames = lines.map(n => ({ name: n, active: true }));
        seats.forEach(s => { s.currentName = ""; s.locked = false; }); 
        distributeNames(); saveToHistory(); renderSeats(); saveState(); handleCloseModal();
        showToast(t.tsSave, 'success');
    }

    function handleSort(type) {
        const t = i18n[currentLang];
        if (type === 'alpha') masterNames.sort((a, b) => a.name.localeCompare(b.name));
        else masterNames.sort((a, b) => b.active - a.active);
        distributeNames(); saveToHistory(); renderSeats(); saveState(); showToast(t.tsSort, 'success');
    }

    function handleApplyGrid() {
        const t = i18n[currentLang];
        const r = parseInt(document.getElementById('inputRows').value);
        const c = parseInt(document.getElementById('inputCols').value);
        if (r > 0 && c > 0) {
            totalRows = r; totalCols = c; initSeats(); saveState(); handleCloseModal();
            showToast(t.tsGrid, 'success');
        }
    }

    function handleEliminateAll() {
        const t = i18n[currentLang];
        if (confirm(t.confAbsAll)) {
            masterNames.forEach(n => n.active = false);
            renderNameList(); distributeNames(); saveToHistory(); renderSeats(); saveState(); showToast(t.tsAbsAll, 'info');
        }
    }

    function handleRestoreAll() {
        const t = i18n[currentLang];
        masterNames.forEach(n => n.active = true);
        renderNameList(); distributeNames(); saveToHistory(); renderSeats(); saveState(); showToast(t.tsPresAll, 'info');
    }

    function handleResetDefault() {
        const t = i18n[currentLang];
        if (confirm(t.confReset)) {
            masterNames = defaultNames.map(n => ({ name: n, active: true }));
            renderNameList(); seats.forEach(s => { s.currentName = ""; s.locked = false; });
            pickerHistory = []; customGenders = {}; 
            distributeNames(); saveToHistory(); renderSeats(); saveState(); showToast(t.tsRes, 'info');
        }
    }

    function handleBackgroundUpload(event) {
        const t = i18n[currentLang];
        const file = event.target.files[0];
        if (!file) return;

        showToast(t.tsProcBg, 'info');
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1920; const MAX_HEIGHT = 1080;
                let width = img.width; let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                } else {
                    if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                }

                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);

                if(compressedDataUrl.length > 4500000) { showToast(t.tsErrBg, 'error'); return; }

                customBackground = compressedDataUrl;
                applyBackground(); saveState(); showToast(t.tsSuccBg, 'success');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
        event.target.value = ''; 
    }

    function handleResetBackground() {
        if (!customBackground) return;
        customBackground = null;
        applyBackground(); saveState(); showToast(i18n[currentLang].tsDelBg, 'info');
    }

    function applyBackground() {
        if (customBackground) {
            document.body.style.backgroundImage = `url('${customBackground}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundAttachment = 'fixed';
        } else {
            document.body.style.backgroundImage = ''; document.body.style.backgroundSize = '';
            document.body.style.backgroundPosition = ''; document.body.style.backgroundAttachment = '';
        }
    }

    function handleSaveJSON() {
        const data = { masterNames, seats, totalRows, totalCols, customBackground, pickerHistory, allowRepeatPick, customGenders, date: new Date().toLocaleString() };
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `denah_${new Date().toISOString().split('T')[0]}.json`;
        a.click(); URL.revokeObjectURL(url); showToast(i18n[currentLang].tsSaveJ, 'success');
    }

    function handleLoadJSON() { document.getElementById('fileInput').click(); }

    function loadJSONFile(event) {
        const t = i18n[currentLang];
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (confirm(t.confLoad)) {
                    masterNames = data.masterNames || []; seats = data.seats || [];
                    totalRows = data.totalRows || 3; totalCols = data.totalCols || 6;
                    customBackground = data.customBackground || null;
                    pickerHistory = data.pickerHistory || [];
                    allowRepeatPick = data.allowRepeatPick || false;
                    customGenders = data.customGenders || {};
                    
                    if(document.getElementById('allowRepeatCheck')) document.getElementById('allowRepeatCheck').checked = allowRepeatPick;

                    saveState(); renderSeats(); applyBackground(); handleCloseModal();
                    showToast(t.tsLoadJ, 'success');
                }
            } catch (e) { showToast(t.tsErrJ, 'error'); }
        };
        reader.readAsText(file); event.target.value = '';
    }

    function showToast(msg, type = 'info') {
        const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = msg;
        document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000);
    }

    function loadData() {
        currentLang = localStorage.getItem('appLang') || 'id';
        const saved = localStorage.getItem('gacha_class_fixed');
        if (saved) {
            const data = JSON.parse(saved);
            masterNames = data.masterNames || []; seats = data.seats || [];
            totalRows = data.totalRows || 3; totalCols = data.totalCols || 6;
            customBackground = data.customBackground || null;
            pickerHistory = data.pickerHistory || [];
            allowRepeatPick = data.allowRepeatPick || false;
            customGenders = data.customGenders || {};
            
            if(document.getElementById('allowRepeatCheck')) document.getElementById('allowRepeatCheck').checked = allowRepeatPick;
            return true;
        }
        return false;
    }

    function saveState() { 
        localStorage.setItem('gacha_class_fixed', JSON.stringify({ masterNames, seats, totalRows, totalCols, customBackground, pickerHistory, allowRepeatPick, customGenders })); 
    }

    function saveToHistory() {
        historyData = historyData.slice(0, historyIndex + 1);
        historyData.push(JSON.stringify({ masterNames, seats })); historyIndex++;
    }

    function getActiveSeatCount() { return seats.filter(s => !s.disabled).length; }

    function detectGender(name) {
        if (knownGenders[name]) return knownGenders[name];
        const n = name.toUpperCase();
        const femaleWords = ["PUTRI", "AYU", "NUR", "SITI", "INTAN", "SARI", "DWI"];
        const maleWords = ["PUTRA", "AKBAR", "FAHMI", "ILHAM", "BUDI", "JOKO", "MUHAMMAD"];
        for (let w of n.split(" ")) {
            if (femaleWords.some(fw => w === fw)) return "F";
            if (maleWords.some(mw => w === mw)) return "M";
        }
        return n.slice(-1).match(/[AIE]/) ? "F" : "M";
    }

    function getAvatarUrl(name) {
        const gender = customGenders[name] || detectGender(name);
        
        // BUG FIX UKURAN AVATAR CEWEK: viewbox="0 100 100" diganti jadi "0 0 100 100"
        const maleSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="#e8f4f8"/><circle cx="50" cy="35" r="20" fill="#2c3e50"/><path d="M15 100 C 15 50, 85 50, 85 100" fill="#2c3e50"/></svg>`;
        const femaleSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="#fce4ec"/><circle cx="50" cy="35" r="20" fill="#2c3e50"/><path d="M20 60 L80 60 L75 100 L25 100 Z" fill="#2c3e50"/></svg>`;
        
        return gender === "F" ? "data:image/svg+xml;utf8," + encodeURIComponent(femaleSvg) : "data:image/svg+xml;utf8," + encodeURIComponent(maleSvg);
    }

    window.toggleGender = function(idx) {
        const seat = seats[idx]; if (!seat.currentName) return;
        const name = seat.currentName;
        const currentGender = customGenders[name] || detectGender(name);
        customGenders[name] = currentGender === 'M' ? 'F' : 'M';
        renderSeats(); saveState();
    };

    function toggleDarkMode() {
        const current = localStorage.getItem('theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        document.documentElement.setAttribute('data-theme', newTheme);
        document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function togglePOV() {
        isTeacherPOV = !isTeacherPOV;
        const t = i18n[currentLang];
        
        const btn = document.getElementById('btnPovToggle');
        const desk = document.getElementById('teacherDeskObj');
        const controls = document.getElementById('controlsObj');
        const topHeader = document.getElementById('topHeader');
        const bottomFooter = document.getElementById('bottomFooter');

        if (isTeacherPOV) {
            btn.innerHTML = t.povS;
            btn.style.background = '#3498db'; btn.style.color = '#fff'; btn.style.borderColor = '#2980b9';
            
            desk.classList.add('pov-guru-mode');
            controls.classList.add('pov-guru-mode');
            
            bottomFooter.appendChild(controls);
            bottomFooter.appendChild(desk);
            bottomFooter.classList.add('show');
            topHeader.style.display = 'none'; 
            
            showToast(t.toastPovT, 'info');
        } else {
            btn.innerHTML = t.povT;
            btn.style.background = 'var(--ui-paper)'; btn.style.color = 'var(--text-dark)'; btn.style.borderColor = 'var(--ui-wood)';
            
            desk.classList.remove('pov-guru-mode');
            controls.classList.remove('pov-guru-mode');
            
            topHeader.appendChild(desk);
            topHeader.appendChild(controls);
            topHeader.style.display = 'flex'; 
            bottomFooter.classList.remove('show');
            
            showToast(t.toastPovS, 'info');
        }

        renderSeats();
    }

    function initSeats() {
        seats = []; const maxS = totalRows * totalCols;
        for (let i = 0; i < maxS; i++) seats.push({ id: i, currentName: "", locked: false, disabled: false });
        distributeNames(); renderSeats();
    }

    function distributeNames() {
        const locked = seats.filter(s => s.locked && !s.disabled && s.currentName).map(s => s.currentName);
        let available = masterNames.filter(n => n.active).map(n => n.name).filter(name => !locked.includes(name));
        
        for (let i = available.length - 1; i > 0; i--) {
            const j = getSecureRandomInt(i + 1);
            [available[i], available[j]] = [available[j], available[i]];
        }
        
        seats.forEach(seat => { 
            if (!seat.locked && !seat.disabled) {
                seat.currentName = available.shift() || "";
            } 
        });
    }

    function renderSeats() {
        const t = i18n[currentLang];
        const container = document.getElementById('classroom');
        const bottomFooter = document.getElementById('bottomFooter');
        
        container.style.gridTemplateColumns = `repeat(${totalCols}, 1fr)`;
        bottomFooter.style.gridTemplateColumns = `repeat(${totalCols}, 1fr)`;

        if (isTeacherPOV) {
            const desk = document.getElementById('teacherDeskObj');
            const controls = document.getElementById('controlsObj');
            
            if (totalCols >= 3) {
                controls.style.gridColumn = '1 / -3'; 
                desk.style.gridColumn = '-3 / -1';    
                controls.style.justifyContent = 'flex-end'; 
            } else {
                controls.style.gridColumn = '1 / -1';
                desk.style.gridColumn = '1 / -1';
                controls.style.justifyContent = 'center';
            }
        }
        
        container.innerHTML = '';
        for (let visualRow = 0; visualRow < totalRows; visualRow++) {
            for (let visualCol = 0; visualCol < totalCols; visualCol++) {
                
                let actualRow = isTeacherPOV ? (totalRows - 1 - visualRow) : visualRow;
                let actualCol = isTeacherPOV ? (totalCols - 1 - visualCol) : visualCol;
                const idx = actualRow * totalCols + actualCol;
                
                const seat = seats[idx];
                const div = document.createElement('div');
                const rowClass = `seat-row-${actualRow % 3}`; 
                
                if (seat.disabled) {
                    div.className = 'seat is-disabled';
                    div.setAttribute('data-label', t.openSeat);
                    div.onclick = () => { seat.disabled = false; distributeNames(); renderSeats(); saveState(); };
                } else {
                    div.className = `seat ${rowClass} ${seat.locked ? 'is-locked' : ''}`;
                    const name = seat.currentName;
                    const avatar = getAvatarUrl(name);
                    let fontSize = "text-normal";
                    if (name.length > 18) fontSize = "text-tiny";
                    else if (name.length > 12) fontSize = "text-small";
                    else if (name.length > 8) fontSize = "text-medium";
                    
                    const currentGender = customGenders[name] || detectGender(name);
                    const genderIcon = currentGender === 'M' ? '‚ôÇ' : '‚ôÄ';

                    div.innerHTML = `
                        <div class="hide-desk-btn" onclick="event.preventDefault(); event.stopImmediatePropagation(); seats[${idx}].disabled = true; distributeNames(); renderSeats(); saveState();">‚úñ</div>
                        <div class="lock-box" onclick="event.preventDefault(); event.stopImmediatePropagation(); if (seats[${idx}].currentName) seats[${idx}].locked = !seats[${idx}].locked; renderSeats(); saveState();">${seat.locked ? 'üîí' : 'üîì'}</div>
                        
                        <div class="gender-btn" onclick="event.preventDefault(); event.stopImmediatePropagation(); toggleGender(${idx});">${genderIcon}</div>
                        
                        <div class="char-img-container"><img src="${avatar}" class="char-img" alt="${name}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=85c1e9&color=fff'"></div>
                        <div class="char-info"><div class="seat-name ${fontSize}">${name || t.emptySeat}</div></div>
                        <div class="seat-number">${t.seatNum}${actualCol + 1}</div>
                    `;
                }
                container.appendChild(div);
            }
        }
        document.getElementById('studentCount').textContent = masterNames.length;
    }

    function renderNameList() {
        const t = i18n[currentLang];
        const list = document.getElementById('nameListContainer');
        const q = document.getElementById('searchInput').value.toUpperCase();
        list.innerHTML = '';
        masterNames.forEach((item, idx) => {
            if (item.name.includes(q)) {
                const div = document.createElement('div');
                div.className = `name-item ${!item.active ? 'eliminated' : ''}`;
                const btn = item.active ? t.statHadir : t.statAbsen;
                const cls = item.active ? 'btn-status-on' : 'btn-status-off';
                div.innerHTML = `<span>${item.name}</span><div style="display:flex;"><button class="action-btn ${cls}" onclick="masterNames[${idx}].active = !masterNames[${idx}].active; renderNameList(); distributeNames(); saveToHistory(); renderSeats(); saveState();">${btn}</button><button class="action-btn btn-edit" onclick="const n = prompt('${t.pmtName}', masterNames[${idx}].name); if(n) { const old = masterNames[${idx}].name; masterNames[${idx}].name = n; seats.forEach(s => { if(s.currentName === old) s.currentName = n; }); renderNameList(); renderSeats(); saveState(); }">‚úé</button><button class="action-btn btn-del" onclick="if(confirm('${t.confDel}')) { masterNames.splice(${idx}, 1); renderNameList(); distributeNames(); renderSeats(); saveState(); }">üóë</button></div>`;
                list.appendChild(div);
            }
        });
    }

    window.addEventListener('load', () => {
        if (!loadData()) initSeats();
        else {
            renderSeats();
            applyBackground(); 
        }
        
        applyLangUI(); 

        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (e.ctrlKey && e.key === 'a') { e.preventDefault(); handleShuffle(); }
        if (e.key === 'Escape') { if (document.getElementById('mainModal').classList.contains('show')) handleBack(); }
    });

</script>
</body>
</html>
